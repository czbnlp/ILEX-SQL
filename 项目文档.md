# ILEX-SQL 项目文档

## 项目概述

ILEX-SQL 是一个双模式智能SQL生成系统，集成了LPE-SQL的经验复用能力与Amber的迭代探索能力。系统通过自然语言处理技术，将用户的问题转化为SQL查询语句，具有高精度和智能化的特点。

### 核心特性

1. **双模式架构**：经验模式 + 探索模式
2. **智能切换**：先尝试经验模式，失败后自动切换到探索模式
3. **执行结果评估**：只评估预测SQL与标准SQL的执行结果一致性
4. **支持并发处理**：可配置并发度进行批量评估
5. **完整的错误处理机制**：包含重试、超时、错误反馈等功能

## 算法流程

### 核心算法逻辑

系统采用"先经验，后探索"的算法流程：

1. **经验模式（LPE-SQL风格）**：
   - 从知识库检索相似的历史问题和SQL对
   - 基于检索结果生成新的SQL查询
   - 如果生成成功且语法正确，返回结果

2. **探索模式（Amber风格）**：
   - 如果经验模式失败，自动切换到探索模式
   - 将复杂问题分解为多个子问题
   - 逐步解决子问题并积累执行记忆
   - 最终合成完整的SQL查询

### 评估逻辑

系统只评估**执行结果的一致性**：
- 执行预测SQL获取结果集
- 执行标准SQL（gold SQL）获取结果集
- 比较两个结果集是否完全一致（使用集合比较）
- 不关心成功率或准确率，只关心结果一致性

## 文件说明

### 核心文件

#### 1. `src/ilex_core/sql_generator_hybrid.py` - 混合SQL生成器
- **作用**：核心控制器，实现双模式切换逻辑
- **关键功能**：
  - 首先尝试经验模式生成SQL
  - 经验模式失败后自动切换到探索模式
  - 管理两种模式的协调工作
  - 收集和统计执行数据

#### 2. `enhanced_sql_generator.py` - 经验模式生成器（LPE-SQL风格）
- **作用**：实现经验模式的SQL生成
- **关键功能**：
  - 从知识库检索相似的历史示例
  - 基于检索结果构建提示词
  - 调用LLM生成SQL查询
  - 提供数据库schema获取功能

#### 3. `src/ilex_core/exploration_engine.py` - 探索引擎（规则版）
- **作用**：实现基于规则的探索模式
- **关键功能**：
  - 问题分解和子问题管理
  - 执行记忆管理
  - 逐步探索和结果合成
  - 支持重试和错误处理

#### 4. `src/ilex_core/exploration_engine_llm.py` - 探索引擎（LLM版）
- **作用**：实现基于LLM的探索模式
- **关键功能**：
  - 使用LLM进行问题分解
  - 智能子问题生成
  - LLM-based结果合成
  - 更智能的探索策略

#### 5. `bird_evaluator_unified.py` - BIRD数据集评估器
- **作用**：评估系统性能和准确性
- **关键功能**：
  - 加载BIRD数据集
  - 执行批量评估（支持并发）
  - 比较预测SQL与标准SQL的执行结果
  - 生成详细的评估报告

#### 6. `sql_executor.py` - SQL执行器
- **作用**：执行SQL查询并管理数据库连接
- **关键功能**：
  - 支持SQLite、PostgreSQL、MySQL
  - 连接池管理
  - 超时控制
  - 错误处理和结果格式化

#### 7. `llm_connector_local.py` - 本地LLM连接器
- **作用**：连接本地vLLM服务
- **关键功能**：
  - 多模型并发连接
  - 自动故障切换
  - 请求重试机制
  - 连接池管理

### 辅助文件

#### 8. `master_sql_postprocessor.py` - SQL后处理器
- **作用**：修复和优化生成的SQL
- **关键功能**：
  - 语法错误修复
  - 特殊字符处理
  - SQL验证和格式化

#### 9. `src/ilex_core/problem_decomposer.py` - 问题分解器
- **作用**：将复杂问题分解为子问题
- **关键功能**：
  - 问题复杂度分析
  - 子问题生成和管理
  - 依赖关系处理

#### 10. `src/ilex_core/execution_memory.py` - 执行记忆管理器
- **作用**：管理探索过程中的执行历史
- **关键功能**：
  - 执行结果存储
  - 上下文生成
  - 记忆检索和重用

### 配置文件

#### 11. `config/ilex_config.yaml` - 主配置文件
- **作用**：系统配置参数
- **包含**：
  - 模式切换参数
  - 探索引擎配置
  - LLM连接配置
  - 数据库连接配置

### 测试和示例文件

#### 12. `run_example.py` - 示例运行器
- **作用**：演示系统功能
- **支持模式**：
  - 基础示例运行
  - 组件测试
  - 交互模式
  - BIRD数据集评估

#### 13. 各种测试文件
- `test_*.py`：各个组件的单元测试
- `bird_test_*.py`：BIRD数据集相关的测试

## 运行指南

### 基础运行

```bash
# 运行示例
python run_example.py

# 测试各个组件
python run_example.py --test

# 交互模式
python run_example.py --interactive
```

### BIRD数据集评估

```bash
# 完整评估（需要vLLM服务）
python run_example.py --bird

# 模拟评估（无需vLLM）
python run_example.py --bird-mock

# 使用统一评估器
python bird_evaluator_unified.py --max-questions 10 --mock
```

### vLLM服务部署

```bash
# 启动本地vLLM服务
bash deploy_vllm.sh
```

## 算法特点

### 1. 双模式智能切换
- 不依赖固定的复杂度阈值
- 先尝试快速的经验模式
- 失败后自动启用探索模式
- 确保覆盖各种复杂度的问题

### 2. 经验模式（LPE-SQL风格）
- 基于历史经验快速生成SQL
- 利用相似问题的解决方案
- 适合简单到中等复杂度的问题
- 执行速度快，准确率高

### 3. 探索模式（Amber风格）
- 逐步分解复杂问题
- 积累中间执行结果
- 支持多步推理和验证
- 适合高复杂度的复杂问题

### 4. 执行结果一致性评估
- 只关注结果的正确性
- 不评估成功率或准确率
- 使用集合比较确保结果一致性
- 支持多种数据类型的比较

## 性能指标

系统提供详细的统计信息：

1. **总体统计**：总问题数、正确数、错误数、超时数
2. **模式使用统计**：经验模式成功率、探索模式使用率
3. **难度分类统计**：按问题难度的详细分析
4. **执行时间统计**：各模式的平均执行时间

## 扩展性

系统具有良好的扩展性：

1. **支持新的LLM模型**：通过LLM连接器接口
2. **支持新的数据库**：通过SQL执行器接口
3. **支持新的评估数据集**：通过评估器接口
4. **支持新的探索策略**：通过探索引擎接口

## 注意事项

1. **vLLM服务**：完整功能需要本地vLLM服务支持
2. **数据库路径**：确保数据库文件路径正确
3. **知识库**：经验模式需要预先构建的知识库
4. **并发设置**：根据硬件配置调整并发度

## 总结

ILEX-SQL系统通过智能的双模式架构，实现了高效准确的SQL生成。系统首先尝试快速的经验模式，失败后自动切换到探索模式，确保对各种复杂度的问题都能给出合适的解决方案。评估逻辑专注于执行结果的一致性，为SQL生成任务提供了可靠的评估标准。